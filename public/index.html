<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Карта</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
        #coordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 1000;
            font-family: monospace;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="coordinates"></div>
    <div id="loading">Загрузка...</div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <script>
        // Глобальные переменные
        let map;
        const imageWidth = 16200;
        const imageHeight = 8100;
        
        // Элементы интерфейса
        const loadingElement = document.getElementById('loading');
        const coordinatesElement = document.getElementById('coordinates');
        
        // Инициализация карты
        function initMap() {
            // 1. Создаем источник тайлов для вашего изображения
            const customTileSource = new ol.source.XYZ({
                url: '/tile/{z}/{x}/{y}.webp',
                maxZoom: 18,
                projection: 'EPSG:3857' // Web Mercator
            });
            
            // 2. Создаем источник для OpenStreetMap
            const osmSource = new ol.source.OSM();
            
            // 3. Создаем слои
            const osmLayer = new ol.layer.Tile({
                source: osmSource,
                opacity: 1
            });
            
            const customLayer = new ol.layer.Tile({
                source: customTileSource,
                opacity: 0.7
            });
            
            // 4. Рассчитываем начальный вид
            // Для тайла [0,0,0] в zoom 0
            const startZoom = 0;
            const startResolution = 156543.03392804062; // Разрешение для zoom 0 в Web Mercator
            
            // Центр изображения в пикселях
            const centerPixelX = imageWidth / 2;
            const centerPixelY = imageHeight / 2;
            
            // Преобразуем пиксели в координаты Web Mercator
            const centerX = centerPixelX * startResolution - 20037508.342789244;
            const centerY = 20037508.342789244 - centerPixelY * startResolution;
            
            // 5. Создаем карту
            map = new ol.Map({
                target: 'map',
                layers: [osmLayer, customLayer],
                view: new ol.View({
                    center: [centerX, centerY],
                    zoom: startZoom,
                    maxZoom: 19
                })
            });
            
            // 6. Обновляем информацию
            updateInfo();
            
            // 7. Обработчики событий
            map.getView().on('change', updateInfo);
            
            // Скрываем загрузчик
            loadingElement.style.display = 'none';
        }
        
        // Обновление информации о координатах
        function updateInfo() {
            if (!map) return;
            
            const view = map.getView();
            const center = view.getCenter();
            const zoom = view.getZoom();
            const resolution = view.getResolution();
            
            // Преобразуем координаты Web Mercator в пиксели
            const scale = 1 / resolution;
            const tileX = Math.floor((center[0] + 20037508.342789244) / (256 * resolution));
            const tileY = Math.floor((20037508.342789244 - center[1]) / (256 * resolution));
            
            // Преобразуем Web Mercator обратно в приблизительные градусы для отображения
            const lon = (center[0] * 180) / 20037508.342789244;
            const lat = (Math.atan(Math.exp(center[1] / 20037508.342789244 * Math.PI)) * 360) / Math.PI - 90;
            
            coordinatesElement.textContent = 
                `Тайл: [${Math.floor(zoom)},${tileX},${tileY}] | ` +
                `Координаты: [${Math.round(lon)}, ${Math.round(lat)}] | ` +
                `Zoom: ${zoom.toFixed(2)}`;
        }
        
        // Инициализируем карту после загрузки страницы
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>